<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Slow Roads — Play</title>
  <style>
    :root{--bg:#dfe7f2;--road:#3a3a3a;--stripe:#f6f0d9;--hud:#ffffffcc}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    body{display:flex;align-items:stretch;background:linear-gradient(180deg,var(--bg) 0%,#ffffff 100%);}
    #app{display:flex;flex:1;gap:12px;padding:12px}
    #game-wrap{flex:1;position:relative;display:flex;align-items:center;justify-content:center}
    canvas{width:100%;height:100%;background:transparent;display:block;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.2)}

    /* Controls panel */
    #panel{width:340px;max-width:34%;background:rgba(255,255,255,0.96);padding:14px;border-radius:10px;overflow:auto}
    h1{font-size:18px;margin:0 0 8px}
    .row{display:flex;gap:8px;align-items:center;margin:8px 0}
    label{flex:1;font-size:13px}
    input[type=range]{flex:1}
    select,input[type=checkbox]{transform:scale(1.05)}
    .big{font-size:14px}
    .button{display:inline-block;padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#f7f7f7;cursor:pointer}
    .footer{font-size:12px;color:#444;margin-top:10px}
    #help{position:absolute;left:16px;bottom:16px;background:var(--hud);padding:8px;border-radius:8px;font-size:13px;color:#222}
    .toggle{display:inline-flex;align-items:center;gap:8px}
  </style>
</head>
<body>
  <div id="app">
    <div id="game-wrap">
      <canvas id="c"></canvas>
      <div id="help">
        <div><strong>Controls</strong></div>
        <div>Arrows / A D / Q : steer, W/Z / S : accelerate/brake, Shift = boost, R = return to road, X = toggle AutoDrive</div>
      </div>
    </div>

    <aside id="panel">
      <h1>Slow Roads — Settings</h1>

      <div class="row">
        <label>Speed (base)</label>
        <input id="speed" type="range" min="2" max="30" value="12">
      </div>

      <div class="row">
        <label>Road width</label>
        <input id="roadWidth" type="range" min="0.3" max="1.6" step="0.01" value="0.9">
      </div>

      <div class="row">
        <label>Lane count</label>
        <input id="lanes" type="range" min="1" max="6" value="3">
      </div>

      <div class="row">
        <label>World</label>
        <select id="worldSelect">
          <option value="earth">On-world (Earth)</option>
          <option value="mars">Off-world (Mars)</option>
        </select>
      </div>

      <div class="row">
        <label>AZERTY layout</label>
        <input id="azerty" type="checkbox">
      </div>

      <div class="row">
        <label>Autodrive</label>
        <input id="autodrive" type="checkbox">
      </div>

      <div class="row">
        <label>Camera FOV</label>
        <input id="fov" type="range" min="40" max="95" value="60">
      </div>

      <div class="row">
        <label>Traction (turn sensitivity)</label>
        <input id="traction" type="range" min="0.3" max="1.5" step="0.01" value="0.95">
      </div>

      <div class="row">
        <label>Show HUD</label>
        <input id="showHud" type="checkbox" checked>
      </div>

      <div class="row">
        <button id="reset" class="button">Reset</button>
        <button id="screenshot" class="button">Screenshot</button>
        <button id="spawnBuilding" class="button">Spawn Building</button>
      </div>

      <div class="footer">Tip: Toggle world to try Mars. Use Shift to boost. Press X to toggle AutoDrive. R recenters you to the road.</div>
    </aside>
  </div>

  <script>
  (function(){
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    let W=800,H=600;
    function resize(){
      const rect = canvas.getBoundingClientRect();
      W = Math.max(320, Math.floor(rect.width));
      H = Math.max(240, Math.floor(rect.height));
      canvas.width = W * devicePixelRatio;
      canvas.height = H * devicePixelRatio;
      canvas.style.width = rect.width+'px';
      canvas.style.height = rect.height+'px';
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    window.addEventListener('resize', resize);
    resize();

    // UI
    const ui = {
      speed: document.getElementById('speed'),
      roadWidth: document.getElementById('roadWidth'),
      lanes: document.getElementById('lanes'),
      worldSelect: document.getElementById('worldSelect'),
      azerty: document.getElementById('azerty'),
      autodrive: document.getElementById('autodrive'),
      fov: document.getElementById('fov'),
      traction: document.getElementById('traction'),
      showHud: document.getElementById('showHud'),
      reset: document.getElementById('reset'),
      screenshot: document.getElementById('screenshot'),
      spawnBuilding: document.getElementById('spawnBuilding')
    };

    // state
    const state = {
      baseSpeed: Number(ui.speed.value),
      speed: Number(ui.speed.value),
      playerX: 0,
      steer: 0,
      roadWidth: Number(ui.roadWidth.value),
      lanes: Number(ui.lanes.value),
      fov: Number(ui.fov.value),
      traction: Number(ui.traction.value),
      world: ui.worldSelect.value,
      azerty: ui.azerty.checked,
      autodrive: ui.autodrive.checked,
      showHud: ui.showHud.checked,
      distance: 0,
      lastTs: performance.now(),
      particles: [],
      buildings: [],
      boost: false
    };

    // input map that supports AZERTY optionally
    const keyState = {};
    const mapKey = (key)=>{
      const k = key.toLowerCase();
      if(state.azerty){
        if(k==='z') return 'w';
        if(k==='q') return 'a';
      }
      return k;
    }

    window.addEventListener('keydown', e=>{
      const k = mapKey(e.key);
      keyState[k]=true;
      if([' ','arrowup','arrowdown','arrowleft','arrowright'].includes(e.key.toLowerCase())) e.preventDefault();
      if(k==='x'){ state.autodrive = !state.autodrive; ui.autodrive.checked = state.autodrive; }
      if(k==='r'){ returnToRoad(); }
    });
    window.addEventListener('keyup', e=>{ keyState[mapKey(e.key)] = false; });

    // UI bindings
    ui.speed.addEventListener('input', ()=>{ state.baseSpeed = Number(ui.speed.value); state.speed = state.baseSpeed; });
    ui.roadWidth.addEventListener('input', ()=> state.roadWidth = Number(ui.roadWidth.value));
    ui.lanes.addEventListener('input', ()=> state.lanes = Number(ui.lanes.value));
    ui.fov.addEventListener('input', ()=> state.fov = Number(ui.fov.value));
    ui.traction.addEventListener('input', ()=> state.traction = Number(ui.traction.value));
    ui.worldSelect.addEventListener('change', ()=>{ state.world = ui.worldSelect.value; resetWorld(); });
    ui.azerty.addEventListener('change', ()=>{ state.azerty = ui.azerty.checked; });
    ui.autodrive.addEventListener('change', ()=>{ state.autodrive = ui.autodrive.checked; });
    ui.showHud.addEventListener('change', ()=> state.showHud = ui.showHud.checked);
    ui.reset.addEventListener('click', ()=>{ resetAll(); });
    ui.screenshot.addEventListener('click', ()=>{ const link = document.createElement('a'); link.download = 'slowroads-'+Date.now()+'.png'; link.href = canvas.toDataURL('image/png'); link.click(); });
    ui.spawnBuilding.addEventListener('click', ()=> spawnBuilding());

    function resetAll(){
      ui.speed.value = 12; ui.roadWidth.value = 0.9; ui.lanes.value = 3; ui.fov.value=60; ui.traction.value=0.95; ui.azerty.checked=false; ui.worldSelect.value='earth'; ui.autodrive.checked=false; ui.showHud.checked=true;
      Object.assign(state, { baseSpeed:12, speed:12, playerX:0, steer:0, roadWidth:0.9, lanes:3, fov:60, traction:0.95, world:'earth', azerty:false, autodrive:false, showHud:true, distance:0, particles:[], buildings:[] });
      resetWorld();
    }

    function resetWorld(){
      state.particles = [];
      state.buildings = [];
      for(let i=0;i<60;i++) spawnBuilding(Math.random()*400 - 200, Math.random()*3000 + state.distance);
    }

    function spawnBuilding(offsetX= (Math.random()*200 - 100), distance = (Math.random()*2000 + state.distance + 200)){
      state.buildings.push({x: offsetX, z: distance, w: 40 + Math.random()*140, h: 80 + Math.random()*400, color: randomBuildingColor()});
      if(state.buildings.length>1200) state.buildings.shift();
    }

    function randomBuildingColor(){
      if(state.world==='mars') return '#b55d3a';
      return ['#9fb7c8','#d9dfe6','#6b8f6a','#cfae82'][Math.floor(Math.random()*4)];
    }

    resetWorld();

    function lerp(a,b,t){return a+(b-a)*t}
    function clamp(x,a,b){return Math.max(a,Math.min(b,x));}

    function returnToRoad(){ state.playerX = 0; state.steer = 0; }

    function drawFrame(ts){
      const now = ts||performance.now();
      const dt = Math.min(0.06,(now - state.lastTs)/1000);
      state.lastTs = now;

      // inputs
      let left = keyState['arrowleft']||keyState['a']||keyState['q'];
      let right = keyState['arrowright']||keyState['d'];
      let up = keyState['arrowup']||keyState['w']||keyState['z'];
      let down = keyState['arrowdown']||keyState['s'];
      const boostKey = keyState['shift']||keyState['shiftleft']||keyState['shiftright'];

      const accel = (up?1:0) - (down?0.6:0);
      state.baseSpeed = Number(ui.speed.value);
      let targetSpeed = state.baseSpeed + accel*8;
      let boostMul = 1;
      if(boostKey){ boostMul = 1.65; }
      if(state.world==='mars') targetSpeed *= 1.05;
      state.speed = lerp(state.speed, targetSpeed * boostMul, clamp(dt*3,0,1));
      state.boost = boostKey;

      // steering
      const steerInput = (left? -1:0) + (right? 1:0);
      if(state.autodrive){
        const desired = -state.playerX * 2.4;
        state.steer = lerp(state.steer, desired * state.traction, dt*2.5);
      } else {
        state.steer += steerInput * 2.6 * dt * state.traction;
        state.steer *= 0.92;
      }
      state.playerX = clamp(state.playerX + state.steer * dt, -2.2, 2.2);

      state.distance += state.speed * dt * (state.world==='mars'?0.85:1);

      // particle effects
      if(state.world==='mars'){
        for(let i=0;i<6;i++) state.particles.push({x:Math.random()*W,y:Math.random()*-200,vy:20+Math.random()*40, life:2+Math.random()*6});
      }
      for(let i=state.particles.length-1;i>=0;i--){ const p=state.particles[i]; p.y += p.vy*dt*(state.world==='mars'?0.6:1.2); p.life -= dt; if(p.life<=0) state.particles.splice(i,1); }

      // background
      if(state.world==='earth'){
        document.body.style.setProperty('--bg','#dfe7f2');
        const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#9fd3ff'); g.addColorStop(1,'#dfe7f2'); ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
      } else {
        document.body.style.setProperty('--bg','#2b1b18');
        const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#3b1711'); g.addColorStop(1,'#602a1f'); ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
      }

      // buildings
      const horizon = H*0.38;
      for(let b of state.buildings){
        const rel = (b.z - state.distance);
        if(rel < -200) continue;
        if(rel > 5000) continue;
        const zScale = 1 / (0.0009 * rel + 0.02);
        const baseX = W/2 + (b.x + state.playerX* (rel*0.002)) * (W*0.0025) * (1/zScale);
        const baseY = lerp(horizon, H+200, Math.min(1, rel/2000));
        const bw = b.w * zScale; const bh = b.h * zScale;
        ctx.fillStyle = b.color; ctx.fillRect(baseX - bw/2, baseY - bh, bw, bh);
        ctx.fillStyle = 'rgba(0,0,0,0.06)';
        for(let yy=0; yy<bh; yy+=12){ for(let xx=0; xx<bw; xx+=14){ ctx.fillRect(baseX - bw/2 + 4 + xx, baseY - bh + 4 + yy, 6,6); }}
      }

      // road
      const centerX = W/2 + state.playerX * W*0.28;
      const roadHalf = W*0.22 * state.roadWidth;
      const segments = 40;
      for(let i=segments-1;i>=0;i--){
        const z1 = (i/segments + (state.distance%1));
        const z2 = ((i+1)/segments + (state.distance%1));
        const scale1 = 1/(z1*2 + 0.08);
        const scale2 = 1/(z2*2 + 0.08);
        const roadW1 = roadHalf * (1/scale1) * 0.5;
        const roadW2 = roadHalf * (1/scale2) * 0.5;
        const curve = Math.sin((state.distance*0.6 + i*0.2))*W*0.005*state.roadWidth;
        const x1 = centerX + curve;
        const x2 = centerX + Math.sin((state.distance*0.6 + (i+1)*0.2))*W*0.005*state.roadWidth;
        const y1 = lerp(horizon, H+120, z1);
        const y2 = lerp(horizon, H+120, z2);
        ctx.beginPath(); ctx.moveTo(x1-roadW1,y1); ctx.lineTo(x1+roadW1,y1); ctx.lineTo(x2+roadW2,y2); ctx.lineTo(x2-roadW2,y2); ctx.closePath(); ctx.fillStyle = (state.world==='mars')? '#2b1b18':'#2f2f2f'; ctx.fill();
        ctx.beginPath(); ctx.moveTo(0,y2); ctx.lineTo(x2-roadW2,y2); ctx.lineTo(x1-roadW1,y1); ctx.lineTo(0,y1); ctx.closePath(); ctx.fillStyle = (state.world==='mars')? '#8a5a4a':'#74a86b'; ctx.fill();
        ctx.beginPath(); ctx.moveTo(W,y2); ctx.lineTo(x2+roadW2,y2); ctx.lineTo(x1+roadW1,y1); ctx.lineTo(W,y1); ctx.closePath(); ctx.fillStyle = (state.world==='mars')? '#8a5a4a':'#74a86b'; ctx.fill();
        const laneCount = state.lanes;
        for(let l=1;l<laneCount;l++){
          const t = l / laneCount;
          const sx1 = lerp(x1-roadW1, x1+roadW1, t);
          const sx2 = lerp(x2-roadW2, x2+roadW2, t);
          ctx.beginPath(); ctx.setLineDash([6,10]); ctx.strokeStyle = (state.world==='mars')? 'rgba(255,240,200,0.9)':'rgba(255,255,255,0.85)'; ctx.lineWidth = Math.max(1,2*(1/scale1)); ctx.moveTo(sx1,y1); ctx.lineTo(sx2,y2); ctx.stroke(); ctx.setLineDash([]);
        }
      }

      // car
      const carY = H*0.82;
      const carX = W/2 + state.playerX*W*0.35;
      const carW = 44; const carH = 68;
      ctx.save(); ctx.translate(carX,carY);
      ctx.beginPath(); ctx.moveTo(0,-carH/2); ctx.lineTo(-carW/2,carH/2); ctx.lineTo(carW/2,carH/2); ctx.closePath(); ctx.fillStyle = state.boost? '#ffd24d':'#ff5a5a'; ctx.shadowColor='rgba(0,0,0,0.35)'; ctx.shadowBlur=12; ctx.fill(); ctx.shadowBlur=0; ctx.restore();

      // hud
      if(state.showHud){
        ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(12,12,200,84);
        ctx.fillStyle='#fff'; ctx.font='14px system-ui'; ctx.fillText('Speed: '+Math.round(state.speed*10)+' km/h',20,34);
        ctx.fillText('World: '+(state.world==='mars'?'Mars':'Earth'),20,54);
        ctx.fillText('AutoDrive: '+(state.autodrive?'On':'Off'),20,74);
        ctx.fillText('Boost: '+(state.boost?'Yes':'No'),20,94);
      }

      // particles overlay
      if(state.world==='mars'){
        ctx.fillStyle='rgba(255,220,180,0.06)';
        for(let p of state.particles){ ctx.fillRect(p.x, p.y, 3, 2); }
      }

      requestAnimationFrame(drawFrame);
    }

    requestAnimationFrame(drawFrame);

    console.log('Slow Roads initialized. Controls: arrows/WASD(or ZQSD for AZERTY), Shift=boost, R=return, X=toggle AutoDrive.');
  })();
  </script>
</body>
</html>
