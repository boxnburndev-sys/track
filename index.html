<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>StreetSim Ultra++ Global Tracker</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html,body,#map{height:100%;margin:0;padding:0}
:root{--panel-bg:rgba(10,14,20,0.95);--accent:#38bdf8;--muted:#9fb6cf;--border:rgba(255,255,255,0.1)}
#map{z-index:0}
#panel{position:absolute;top:0;left:0;width:440px;height:100%;background:var(--panel-bg);
  color:#eef;font-family:Inter,system-ui;z-index:1500;overflow:auto;padding:14px}
#panel h1{margin:0;font-size:20px;color:#fff}
#panel h2{margin:12px 0 4px 0;font-size:15px;color:#fff}
#panel label{display:block;font-size:13px;color:var(--muted);margin-top:6px}
#panel input[type=text],#panel select,#panel input[type=color],#panel input[type=range]{
  width:100%;padding:4px 6px;border-radius:6px;border:none;margin-top:2px;background:#1a2230;color:#fff}
#panel input[type=checkbox]{margin-right:4px}
.section{margin-top:12px;padding-top:10px;border-top:1px solid var(--border)}
.btn{padding:6px 12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;border:none}
.btn.primary{background:var(--accent);color:#02121a}
.btn.ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
.row{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-top:6px}
#hud{margin-top:10px;background:rgba(0,0,0,0.25);padding:8px;border-radius:8px;font-size:13px;line-height:1.35;max-height:240px;overflow:auto}
#hud .agent{border-bottom:1px solid rgba(255,255,255,0.08);padding:6px 0}
#hud .agent:last-child{border-bottom:none}
#hud span{display:inline-block;min-width:60px}
.toggle{position:absolute;top:10px;left:460px;z-index:2000;background:var(--accent);color:#02121a;
  padding:6px 12px;border-radius:8px;cursor:pointer;font-weight:600}
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <h1>StreetSim Ultra++ Global</h1>
  <p style="color:var(--muted);font-size:13px">Worldwide synthetic tracking with lights, stops & agents</p>
  <div class="section">
    <h2>Agents</h2>
    <label>Custom Name</label>
    <input type="text" id="agentName" placeholder="Name"/>
    <label>Profile</label>
    <select id="agentProfile">
      <option value="walk">Walk</option>
      <option value="bike">Bike</option>
      <option value="drive" selected>Drive</option>
    </select>
    <div class="row">
      <button id="addAgent" class="btn primary">Add Agent</button>
      <button id="removeAgent" class="btn ghost">Remove Last</button>
    </div>
  </div>
  <div class="section">
    <h2>Simulation</h2>
    <label>Speed Multiplier <span id="speedLabel">1.0×</span></label>
    <input type="range" min="0.25" max="4" step="0.25" value="1" id="speedMult"/>
    <div class="row">
      <label><input type="checkbox" id="realistic" checked/> Realistic Accel/Decel</label>
    </div>
    <div class="row">
      <button id="pauseAll" class="btn ghost">Pause</button>
      <button id="toggleTrails" class="btn ghost">Toggle Trails</button>
    </div>
  </div>
  <div class="section">
    <h2>Traffic System</h2>
    <label>Traffic Light Color</label>
    <input type="color" id="lightColor" value="#ff0000"/>
    <label>Stop Sign Color</label>
    <input type="color" id="stopColor" value="#ffffff"/>
    <div class="row"><button id="applyColors" class="btn primary">Apply Colors</button></div>
  </div>
  <div class="section">
    <h2>Data</h2>
    <div class="row">
      <button id="export" class="btn ghost">Export CSV</button>
      <button id="clearAll" class="btn ghost">Clear All</button>
    </div>
  </div>
  <div id="hud"></div>
</div>
<div class="toggle" id="togglePanel">Hide Panel</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const OSRM='https://router.project-osrm.org'
const SPEEDS={walk:1.4,bike:5,drive:13}
const COLORS=['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#17becf']
const map=L.map('map').setView([30,0],3)
L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
  subdomains:['mt0','mt1','mt2','mt3'],maxZoom:20,attribution:'Imagery © Google'
}).addTo(map)
let agents=new Map(),lights=new Map(),stops=new Map(),nextId=1,running=true,mult=1
class Agent{
  constructor(id,name,coords,baseSpeed,color,profile){
    this.id=id;this.name=name;this.profile=profile;this.color=color
    this.points=coords.map(c=>({lat:c[1],lng:c[0]}))
    this.dist=[0]
    for(let i=1;i<this.points.length;i++)this.dist[i]=this.dist[i-1]+distance(this.points[i-1],this.points[i])
    this.total=this.dist.at(-1)
    this.p=0;this.speed=0;this.targetSpeed=baseSpeed;this.baseSpeed=baseSpeed;this.finished=false
    this.marker=L.circleMarker(this.points[0],{radius:7,color:'#000',fillColor:color,fillOpacity:1}).addTo(map).bindTooltip(name,{permanent:true,offset:[12,0]})
    this.trail=L.polyline([], {color,weight:3,opacity:.8}).addTo(map)
    this.trace=[];this.state="moving"
  }
  remove(){this.marker.remove();this.trail.remove()}
  posAt(m){if(m<=0)return this.points[0];if(m>=this.total)return this.points.at(-1)
    let i=this.dist.findIndex(x=>x>=m);if(i<1)i=1
    let t=(m-this.dist[i-1])/(this.dist[i]-this.dist[i-1])
    return lerp(this.points[i-1],this.points[i],t)}
  step(dt,mult,realistic){
    if(this.finished)return
    let pos=this.posAt(this.p);let sp=this.baseSpeed*mult;this.state="moving"
    for(const l of lights.values()){if(distance(pos,l.latlng)<22&&l.state==='red'){sp=0;this.state="red light"}}
    for(const s of stops.values()){if(distance(pos,s.latlng)<15&&!s.passed.has(this.id)){sp=0;this.state="stop";s.passed.add(this.id);setTimeout(()=>{s.passed.delete(this.id)},3000)}}
    this.targetSpeed=sp;let accel=realistic?2:99;let diff=this.targetSpeed-this.speed;this.speed+=Math.sign(diff)*Math.min(Math.abs(diff),accel*dt)
    this.p+=this.speed*dt;if(this.p>=this.total){this.p=this.total;this.finished=true;this.state="arrived"}
    const cur=this.posAt(this.p);this.marker.setLatLng(cur)
    let arr=this.trail.getLatLngs();arr.push(cur);if(arr.length>250)arr.shift();this.trail.setLatLngs(arr)
    this.trace.push({t:Date.now(),lat:cur.lat,lng:cur.lng,spd:this.speed,state:this.state})
  }
}
class TrafficLight{
  constructor(latlng){this.latlng=latlng;this.state='red'
    this.marker=L.circleMarker(latlng,{radius:8,color:'#fff',fillColor:'red',fillOpacity:.8}).addTo(map)
    setInterval(()=>this.toggle(),10000)}
  toggle(){this.state=this.state==='red'?'green':'red';this.marker.setStyle({fillColor:this.state==='red'?'red':'lime'})}
}
class StopSign{
  constructor(latlng){this.latlng=latlng
    this.marker=L.circleMarker(latlng,{radius:6,color:'#000',fillColor:'#fff',fillOpacity:.9}).addTo(map)
    this.passed=new Set()}
}
function distance(a,b){const R=6371e3;const φ1=a.lat*Math.PI/180,φ2=b.lat*Math.PI/180
  const dφ=(b.lat-a.lat)*Math.PI/180,dλ=(b.lng-a.lng)*Math.PI/180
  const s=Math.sin(dφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2
  return 2*R*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))}
function lerp(a,b,t){return{lat:a.lat+(b.lat-a.lat)*t,lng:a.lng+(b.lng-a.lng)*t}}
async function route(o,d){const url=`${OSRM}/route/v1/driving/${o.lng},${o.lat};${d.lng},${d.lat}?overview=full&geometries=geojson`
  const r=await fetch(url);const j=await r.json();return j.routes[0].geometry.coordinates}
function rand(a,b){return a+Math.random()*(b-a)}
function randomPoint(){return L.latLng(rand(-55,55),rand(-170,170))}
function updateHUD(){const div=document.getElementById('hud');div.innerHTML=''
  agents.forEach(a=>{const cur=a.posAt(a.p)
    div.innerHTML+=`<div class="agent"><b>${a.name}</b> (${a.profile})<br>
    <span>Speed:</span>${a.speed.toFixed(1)} m/s<br>
    <span>State:</span>${a.state}<br>
    <span>Lat:</span>${cur.lat.toFixed(4)}<br>
    <span>Lng:</span>${cur.lng.toFixed(4)}</div>`})}
document.getElementById('addAgent').onclick=async()=>{const prof=document.getElementById('agentProfile').value
  const name=document.getElementById('agentName').value||"Agent "+nextId
  const o=randomPoint(),d=randomPoint();const coords=await route(o,d)
  const id='A'+nextId++,sp=SPEEDS[prof]||SPEEDS.drive
  agents.set(id,new Agent(id,name,coords,sp,COLORS[nextId%COLORS.length],prof))}
document.getElementById('removeAgent').onclick=()=>{const k=[...agents.keys()].pop();if(!k)return
  agents.get(k).remove();agents.delete(k)}
document.getElementById('pauseAll').onclick=()=>{running=!running}
document.getElementById('speedMult').oninput=e=>{mult=parseFloat(e.target.value);document.getElementById('speedLabel').innerText=mult+'×'}
document.getElementById('toggleTrails').onclick=()=>{agents.forEach(a=>a.trail.setStyle({opacity:a.trail.options.opacity?0:.8}))}
document.getElementById('applyColors').onclick=()=>{const lc=document.getElementById('lightColor').value;const sc=document.getElementById('stopColor').value
  lights.forEach(l=>l.marker.setStyle({fillColor:lc}));stops.forEach(s=>s.marker.setStyle({fillColor:sc}))}
document.getElementById('export').onclick=()=>{let csv='id,name,profile,t,lat,lng,spd,state\n'
  agents.forEach((a,id)=>{a.trace.forEach(r=>csv+=`${id},${a.name},${a.profile},${r.t},${r.lat},${r.lng},${r.spd},${r.state}\n`)})
  download(csv,'agents.csv')}
document.getElementById('clearAll').onclick=()=>{agents.forEach(a=>a.remove());agents.clear()}
function download(content,name){const a=document.createElement('a')
  a.href=URL.createObjectURL(new Blob([content]));a.download=name;a.click()}
map.on('click',async e=>{const k=[...agents.keys()].pop();if(!k)return
  const old=agents.get(k);old.remove();const coords=await route(old.marker.getLatLng(),e.latlng)
  agents.set(k,new Agent(old.id,old.name,coords,old.baseSpeed,old.color,old.profile))})
function placeGlobalLights(){for(let i=0;i<30;i++){lights.set('L'+i,new TrafficLight(randomPoint()))}
  for(let j=0;j<30;j++){stops.set('S'+j,new StopSign(randomPoint()))}}
placeGlobalLights()
let last=performance.now()
function loop(t){const dt=(t-last)/1000;last=t
  if(running)agents.forEach(a=>a.step(dt,mult,document.getElementById('realistic').checked))
  updateHUD();requestAnimationFrame(loop)}
requestAnimationFrame(loop)
const toggle=document.getElementById('togglePanel')
const panel=document.getElementById('panel')
let visible=true
toggle.onclick=()=>{visible=!visible
  panel.style.display=visible?'block':'none'
  toggle.innerText=visible?'Hide Panel':'Show Panel'}
</script>
</body>
</html>
